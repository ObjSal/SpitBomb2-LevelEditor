'use strict';import{Map}from"./map.js";import{Player}from"./player.js";const speed=4;const intervalMs=8;const ArrowUp="arrowup";const ArrowDown="arrowdown";const ArrowLeft="arrowleft";const ArrowRight="arrowright";export class Game{constructor(a){this.map=a;this.map.backgroundFillColor=this.map.backgroundFillColor+"55";this.spawnLocations=this.availableSpawnLocations();this.keys={movePriority:[],wasdPriority:[]}}demo(a){let b=this.spawnLocations[Math.round(Math.random()*(this.spawnLocations.length-1))];this.player=new Player(b.x,b.y,"images/player/black",this.map);this.end=false;this.startGameLoop(a)}stop(a){this.completion=a;this.end=true}isCombination(a,b,c,d){if(d){return a===c&&b===d||a===d&&b===c}else{return a===c||b===c}}excludeEachOther(a,b){return this.isCombination(a,b,Player.Direction.North,Player.Direction.South)||this.isCombination(a,b,Player.Direction.East,Player.Direction.West)}updatePlayer(a,b){const c=speed*b;let d=0,e=0;let f=this.keys.movePriority;let g=this.mapKeyToPlayerDirection(f[f.length-1]);let h=this.mapKeyToPlayerDirection(f[f.length-2]);if(this.excludeEachOther(g,h)){h=null}if(this.isCombination(g,h,Player.Direction.North)){e=-c}if(this.isCombination(g,h,Player.Direction.South)){e=c}if(this.isCombination(g,h,Player.Direction.West)){d=-c}if(this.isCombination(g,h,Player.Direction.East)){d=c}a.player.move(d,e,this.mapKeyToPlayerDirection(f[f.length-1]));let i=this.keys.wasdPriority;a.player.setDirection(this.mapKeyToPlayerDirection(i[i.length-1]),this.mapKeyToPlayerDirection(i[i.length-2]));a.player.updateBombs(b);if(a.keys[" "]){this.player.action=Player.Action.Open;a.player.fire()}else{this.player.action=Player.Action.Closed}}update(a,b){a.updatePlayer(a,b)}startGameLoop(a){let b=performance.now();let c=this;requestAnimationFrame(function d(e){let f=(e-b)/intervalMs;c.update(c,f);c.draw(a);b=e;if(c.end){if(c.completion)c.completion()}else{requestAnimationFrame(d)}})}availableSpawnLocations(){let a=[];for(let b=0;b<this.map.height-Player.size;b+=this.map.cellSize){for(let c=0;c<this.map.width-Player.size;c+=this.map.cellSize){let d=false;for(let a of this.map.blocks){if(a.hitTest(c+1,b+1,Player.size-2,Player.size-2)){d=true;break}}if(!d){a.push({x:c,y:b})}}}return a}mapKeyToPlayerDirection(a){switch(a){case"w":case ArrowUp:{return Player.Direction.North}case"s":case ArrowDown:{return Player.Direction.South}case"a":case ArrowLeft:{return Player.Direction.West}case"d":case ArrowRight:{return Player.Direction.East}default:{}}}arrowKey(a){return a===ArrowUp||a===ArrowDown||a===ArrowLeft||a===ArrowRight}wasdKey(a){return a==="w"||a==="a"||a==="s"||a==="d"}onKeyDown(a){let b=a.key.toLowerCase();if(!this.keys[b]){this.keys[b]=true;if(this.arrowKey(b)){this.keys.movePriority.push(b)}if(this.wasdKey(b)){this.keys.wasdPriority.push(b)}}}onKeyUp(a){let b=a.key.toLowerCase();this.keys[b]=false;if(this.arrowKey(b)){let a=this.keys.movePriority.indexOf(b);this.keys.movePriority.splice(a,1)}if(this.wasdKey(b)){let a=this.keys.wasdPriority.indexOf(b);this.keys.wasdPriority.splice(a,1)}}draw(a){this.map.draw(a);a.save();a.translate(this.map.x,this.map.y);this.player.draw(a);a.restore()}}