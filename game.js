'use strict';import{Map}from"./map.js";import{Player}from"./player.js";const speed=4;const intervalMs=8;export class Game{constructor(a){this.map=a;this.map.backgroundFillColor=this.map.backgroundFillColor+"55";this.spawnLocations=this.availableSpawnLocations();this.keys={keyUp:false,keyDown:false,keyLeft:false,keyRight:false,keySpace:false,priority:[]}}demo(a){let b=this.spawnLocations[Math.round(Math.random()*(this.spawnLocations.length-1))];this.player=new Player(b.x,b.y,"images/player/black",this.map);this.end=false;this.startGameLoop(a)}stop(a){this.completion=a;this.end=true}updatePlayer(a,b){const c=speed*b;let d=0,e=0;if(a.keys.keyUp){e=-c}if(a.keys.keyDown){e=c}if(a.keys.keyLeft){d=-c}if(a.keys.keyRight){d=c}let f=this.keys.priority.length>0?this.keys.priority[this.keys.priority.length-1]:null;a.player.move(d,e,f);a.player.updateBombs(b);if(a.keys.keySpace){a.player.fire()}}update(a,b){a.updatePlayer(a,b)}startGameLoop(a){let b=performance.now();let c=this;requestAnimationFrame(function d(e){let f=(e-b)/intervalMs;c.update(c,f);c.draw(a);b=e;if(c.end){if(c.completion)c.completion()}else{requestAnimationFrame(d)}})}availableSpawnLocations(){let a=[];for(let b=0;b<this.map.height-Player.size;b+=this.map.cellSize){for(let c=0;c<this.map.width-Player.size;c+=this.map.cellSize){let d=false;for(let a of this.map.blocks){if(a.hitTest(c+1,b+1,Player.size-2,Player.size-2)){d=true;break}}if(!d){a.push({x:c,y:b})}}}return a}onKeyDown(a){if(!this.keys.keyUp&&a.key==="ArrowUp"){this.keys.keyUp=true;this.keys.priority.push(Player.Direction.North)}if(!this.keys.keyDown&&a.key==="ArrowDown"){this.keys.keyDown=true;this.keys.priority.push(Player.Direction.South)}if(!this.keys.keyLeft&&a.key==="ArrowLeft"){this.keys.keyLeft=true;this.keys.priority.push(Player.Direction.West)}if(!this.keys.keyRight&&a.key==="ArrowRight"){this.keys.keyRight=true;this.keys.priority.push(Player.Direction.East)}if(!this.keys.keySpace&&a.key===" "){this.keys.keySpace=true;this.player.action=Player.Action.Open}}onKeyUp(a){if(a.key==="ArrowUp"){this.keys.keyUp=false;let a=this.keys.priority.indexOf(Player.Direction.North);this.keys.priority.splice(a,1)}if(a.key==="ArrowDown"){this.keys.keyDown=false;let a=this.keys.priority.indexOf(Player.Direction.South);this.keys.priority.splice(a,1)}if(a.key==="ArrowLeft"){this.keys.keyLeft=false;let a=this.keys.priority.indexOf(Player.Direction.West);this.keys.priority.splice(a,1)}if(a.key==="ArrowRight"){this.keys.keyRight=false;let a=this.keys.priority.indexOf(Player.Direction.East);this.keys.priority.splice(a,1)}if(a.key===" "){this.keys.keySpace=false;this.player.action=Player.Action.Closed}}draw(a){this.map.draw(a);a.save();a.translate(this.map.x,this.map.y);this.player.draw(a);a.restore()}}